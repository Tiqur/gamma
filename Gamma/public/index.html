<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQLite Card Management</title>
    <link rel="stylesheet" href="main.css">
</head>
<body>
    <h1>Data from SQLite Database</h1>

    <!-- Filter by tag -->
    <label for="filterTag">Filter by Tag:</label>
    <input type="text" id="filterTag" oninput="filterCards()" placeholder="Enter tag name...">

    <!-- Filter by content -->
    <label for="filterContent">Filter by Content:</label>
    <input type="text" id="filterContent" oninput="filterCards()" placeholder="Enter content...">

    <!-- Add new card -->
    <button id="addNewCardButton" class="add-button" onclick="openAddCardModal()">
      <svg width="48px" height="48px" viewBox="0 0 24 24" fill="red" xmlns="http://www.w3.org/2000/svg">
        <path d="M11 8C11 7.44772 11.4477 7 12 7C12.5523 7 13 7.44771 13 8V11H16C16.5523 11 17 11.4477 17 12C17 12.5523 16.5523 13 16 13H13V16C13 16.5523 12.5523 17 12 17C11.4477 17 11 16.5523 11 16V13H8C7.44772 13 7 12.5523 7 12C7 11.4477 7.44771 11 8 11H11V8Z" fill="#4b5263"/>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M23 4C23 2.34315 21.6569 1 20 1H4C2.34315 1 1 2.34315 1 4V20C1 21.6569 2.34315 23 4 23H20C21.6569 23 23 21.6569 23 20V4ZM21 4C21 3.44772 20.5523 3 20 3H4C3.44772 3 3 3.44772 3 4V20C3 20.5523 3.44772 21 4 21H20C20.5523 21 21 20.5523 21 20V4Z" fill="#4b5263"/>
      </svg>
    </button>
    
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Tag</th>
                <th>Front</th>
                <th>Back</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="cardsTable">
            <!-- Cards will be dynamically populated here -->
        </tbody>
    </table>

    <!-- The Modal -->
    <div id="updateModal" class="modal">
        <!-- Modal content -->
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <form id="updateCardForm">
                <label for="updateTag">Tag:</label>
                <input type="text" id="updateTag" /><br>
                <label for="updateFront">Front:</label>
                <textarea id="updateFront" rows="4"></textarea><br>
                <label for="updateBack">Back:</label>
                <textarea id="updateBack" rows="4"></textarea><br>
                <button type="button" onclick="submitUpdate()">Update Card</button>
            </form>
        </div>
    </div>

    <!-- Add New Card Modal -->
    <div id="addCardModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddCardModal()">&times;</span>
            <form id="addCardForm">
                <label for="newTag">Tag:</label>
                <input type="text" id="newTag" /><br>
                <label for="newFront">Front:</label>
                <textarea id="newFront" rows="4"></textarea><br>
                <label for="newBack">Back:</label>
                <textarea id="newBack" rows="4"></textarea><br>
                <button type="button" onclick="addCard()">Add Card</button>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <p>Are you sure you want to delete this card?</p>
            <button onclick="confirmDelete()">Yes</button>
            <button onclick="closeConfirmation()">No</button>
        </div>
    </div>

    <!-- Snackbar Container -->
    <div id="snackbarContainer" class="snackbar-container"></div>

    <script>
        document.addEventListener('DOMContentLoaded', fetchCards);

        function fetchCards() {
            fetch('/data')
                .then(response => response.json())
                .then(data => {
                    const cardsTable = document.getElementById('cardsTable');
                    const fragment = document.createDocumentFragment(); // Use document fragment for efficiency
                    data.forEach(card => {
                        const row = createCardRow(card);
                        fragment.appendChild(row);
                    });
                    cardsTable.innerHTML = ''; // Clear existing rows
                    cardsTable.appendChild(fragment); // Append all rows at once
                })
                .catch(error => console.error('Error fetching cards:', error));
        }

        function createCardRow(card) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${card.id}</td>
                <td>${card.tag}</td>
                <td>${card.front}</td>
                <td>${card.back}</td>
                <td>
                    <button type="button" class="update-button">Update</button>
                    <button type="button" class="delete-button">Delete</button>
                </td>
            `;
            row.querySelector('.update-button').addEventListener('click', () => openModal(card.id, card.front, card.back, card.tag));
            row.querySelector('.delete-button').addEventListener('click', () => deleteCard(card.id));
            return row;
        }

        function filterCards() {
            const filterTagValue = document.getElementById('filterTag').value.toLowerCase();
            const filterContentValue = document.getElementById('filterContent').value.toLowerCase();
            const rows = document.querySelectorAll('#cardsTable tr');

            rows.forEach(row => {
                const tag = row.getElementsByTagName('td')[1];
                const front = row.getElementsByTagName('td')[2];
                const back = row.getElementsByTagName('td')[3];

                if (tag && front && back) {
                    const tagText = tag.textContent.toLowerCase();
                    const frontText = front.textContent.toLowerCase();
                    const backText = back.textContent.toLowerCase();

                    if (tagText.includes(filterTagValue) &&
                        (frontText.includes(filterContentValue) || backText.includes(filterContentValue))) {
                        row.style.display = ''; // Show matching rows
                    } else {
                        row.style.display = 'none'; // Hide non-matching rows
                    }
                }
            });
        }

        function openModal(id, front, back, tag) {
            const modal = document.getElementById('updateModal');
            modal.style.display = 'block';

            // Populate fields with current card data
            document.getElementById('updateFront').value = front;
            document.getElementById('updateBack').value = back;
            document.getElementById('updateTag').value = tag;

            // Store the ID in a hidden field or variable
            modal.dataset.cardId = id;
        }

        function closeModal() {
            const modal = document.getElementById('updateModal');
            modal.style.display = 'none';
        }

        function submitUpdate() {
            const id = document.getElementById('updateModal').dataset.cardId;
            const front = document.getElementById('updateFront').value;
            const back = document.getElementById('updateBack').value;
            const tag = document.getElementById('updateTag').value;
            const data = `id=${id}&front=${encodeURIComponent(front)}&back=${encodeURIComponent(back)}&tag=${encodeURIComponent(tag)}`;

            fetch('/data', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: data
            })
            .then(response => {
                if (response.status === 200) {
                    showSnackbar('Card updated successfully!');
                    closeModal();
                    fetchCards();
                } else {
                    showSnackbar('Error updating card', '#e06c75');
                }
            })
            .catch(error => console.error('Error updating card:', error));
        }

        function deleteCard(id) {
            const confirmationModal = document.getElementById('confirmationModal');
            confirmationModal.style.display = 'block';

            // Store the ID in a hidden field or variable
            confirmationModal.dataset.cardId = id;
        }

        function confirmDelete() {
            const id = document.getElementById('confirmationModal').dataset.cardId;
            const data = `id=${id}`;

            fetch('/data', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: data
            })
            .then(response => {
                if (response.status === 200) {
                    showSnackbar('Card deleted successfully!');
                    fetchCards();
                } else {
                    showSnackbar('Error deleting card', '#e06c75');
                }
            })
            .catch(error => console.error('Error deleting card:', error));

            closeConfirmation(); // Close the confirmation modal after deleting
        }

        function closeConfirmation() {
            const confirmationModal = document.getElementById('confirmationModal');
            confirmationModal.style.display = 'none';
        }

        // Function to add a new card
        function addCard() {
            const front = document.getElementById('newFront').value;
            const back = document.getElementById('newBack').value;
            const tag = document.getElementById('newTag').value;
            const data = `front=${encodeURIComponent(front)}&back=${encodeURIComponent(back)}&tag=${encodeURIComponent(tag)}`;

            fetch('/data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: data
            })
            .then(response => {
                if (response.status === 200) {
                    showSnackbar('Card added successfully!');
                    closeAddCardModal(); // Close modal after adding card
                    fetchCards(); // Refresh cards table
                } else {
                    showSnackbar('Error adding card', '#e06c75');
                }
            })
            .catch(error => console.error('Error adding card:', error));
        }

        function showSnackbar(message, color = '#61afef') {
            const snackbarContainer = document.getElementById('snackbarContainer');
            
            // Create snackbar element
            const snackbar = document.createElement('div');
            snackbar.className = 'snackbar';
            snackbar.style.backgroundColor = color;
            snackbar.textContent = message;

            // Append snackbar to container
            snackbarContainer.appendChild(snackbar);

            // Trigger slide-in animation
            setTimeout(() => {
                snackbar.style.visibility = 'visible';
                snackbar.style.animation = 'slideIn 0.5s ease-in-out, fadeOut 0.5s ease-in-out 2.5s'; // Reset animation
            }, 100); // Delay to ensure visibility change is applied after appending

            // Automatically remove snackbar after animation completes
            setTimeout(() => {
                snackbar.remove();
            }, 3000);
        }

        // Function to open the add card modal
        function openAddCardModal() {
            const addCardModal = document.getElementById('addCardModal');
            addCardModal.style.display = 'block';
        }

        // Function to close the add card modal
        function closeAddCardModal() {
            const addCardModal = document.getElementById('addCardModal');
            addCardModal.style.display = 'none';
        }
    </script>
</body>
</html>

